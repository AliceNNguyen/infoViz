<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>InfoVis 17/18 - ALG II München</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" type="text/css" href="css/dc.css">
  <link rel="stylesheet" type="text/css" href="css/bootstrap.css">
  <link rel="stylesheet" type="text/css" href="css/main.css">
</head>

<body>
  <div class="container-fluid">
    <div class="row">
      <div class="col-xs-12 dc-data-count dc-chart" id="data-count">
        <h2>ALG II Empfängerdichte München
        <small>
          <span class="filter-count"></span> von <span class="total-count"></span> Einträgen selektiert. |
           <a id="all" href="#">Zurücksetzen</a>
          </span>
        </small>
      </h2>
      </div>
    </div>
    <div class="row">
      <div class="col-xs-2 pie-chart">
        <h4>Empfänger pro Jahr</h4>
        <div class="dc-chart" id="chart-ring-year"></div>
      </div>
      <div class="col-xs-2 pie-chart">
        <h4>Empfänger pro Ausprägung</h4>
        <div class="dc-chart" id="chart-ring-shape"></div>
      </div>
    </div>
    <div class="row">
      <div class="col-xs-6">
        <h4>Empfänger pro Stadtteil in Bewohnern</h4>
        <div class="dc-chart" id="chart-district" style="width:100%;"></div>
      </div>
      <div class="col-xs-6">
        <h4>Empfänger pro Stadtteil in Prozent</h4>
        <div class="dc-chart" id="chart-district-percent" style="width:100%;"></div>
      </div>
    </div>
    <div class="row">
      <!-- <div class="col-xs-6 col-md-3">
      <div class="dc-chart" id="chart-rating-count"></div>
    </div>
    <div class="col-xs-6 col-md-3">
      <div class="dc-chart" id="chart-community-rating-count"></div>
    </div>
    <div class="col-xs-6 col-md-3">
      <div class="dc-chart" id="chart-abv-count"></div>
    </div>
    <div class="col-xs-6 col-md-3">
      <div class="dc-chart" id="chart-ibu-count"></div>
    </div> -->
    </div>
    <div class="row">
      <div class="col-xs-12">
        <table class="table table-bordered table-striped" id="data-table">
          <thead>
            <tr class="header">
              <th>Stadtteil Nr.</th>
              <th>Stadtteil</th>
              <th>Ausprägung</th>
              <th>Jahr</th>
              <th>Bevölkerung Stadtteil</th>
              <th>ALG II Empfänger</th>
            </tr>
          </thead>
        </table>
      </div>
    </div>
  </div>

  <div class="container-fluid">
  <div class="row">
    <div class="col-xs-12 dc-data-count dc-chart" id="foreigner-data-count">
      <h2>Ausländeranteil, Geburtenrate und ArbeitslosengeldII-Empfänger
      <small>
        <span class="foreigner-filter-count"></span> von <span class="foreigner-total-count"></span> Einträgen selektiert. |
         <a id="all" href="#">Zurücksetzen</a>
        </span>
      </small>
    </h2>
    </div>
  </div>

  <div class="row">
    <div class="dc-chart "id="munich-map"></div>
  </div>

  <div class="row">
    <div class="col-xs-2 pie-chart">
      <h4>Verteilung nach Jahren</h4>
      <div class="dc-chart" id="distribution-chart-ring-year"></div>
    </div>
    <!--<div class="col-xs-2 pie-chart">
      <h4>Empfänger pro Ausprägung</h4>
      <div class="dc-chart" id="chart-ring-shape"></div>
    </div>-->
  </div>

<div class="row">
    <div class="col-xs-6">
      <h4>Verteilung pro Stadtteil</h4>
      <div class="dc-chart" id="distribution-chart-district" style="width:100%;"></div>
    </div>
    <div class="col-xs-6">
      <h4>Verteilung pro Stadtteil in Prozent</h4>
      <div class="dc-chart" id="foreigner-chart-district-percent" style="width:100%;"></div>
    </div>
  </div>

<div class="row">
  <div class="col-xs-12">
    <h4>Entwicklung der Verteilungen nach Jahren</h4>
    <div class="dc-chart" id="total-distribution" style="width:100%"></div>
  </div>
</div>

  <div class="row">
    <div class="col-xs-12">
      <table class="table table-bordered table-striped" id="total-data-table">
        <thead>
          <tr class="header">
            <th>Stadtteil Nr.</th>
            <th>Stadtteil</th>
            <th>Ausprägung</th>
            <th>Jahr</th>
            <th>Bevölkerung Stadtteil</th>
            <th>Ausländer</th>
            <th>Geburten</th>
            <th>ArbeitslosengeldII-Empfänger</th>
          </tr>
        </thead>
      </table>
    </div>
  </div>
</div>


  <script type="text/javascript" src="js/d3.js"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>

  <script type="text/javascript" src="js/crossfilter.js"></script>
  <script type="text/javascript" src="js/dc.js"></script>
  <script type="text/javascript" src="js/underscore-min.js"></script>
  <script type="text/javascript">

    // Parse JSON file
    d3.json('data_algii_clean.json', function(error, data) {
      var data = data;

      // normalize/parse data
      _.each(data, function(d) {
        d.year = +d.year;
        d.population = +d.population
        d.unemployed = +d.unemployed
        d.districtNumber = +d.districtNumber

      });

      // set crossfilter
      var ndx = crossfilter(data);

      // create dimensions (x-axis values)
      var yearDim = ndx.dimension(function(d) {
          return d.year;
        }),
        shapeDim = ndx.dimension(dc.pluck('shape')),
        districtDim = ndx.dimension(dc.pluck('district')),
        unemployedDim = ndx.dimension(dc.pluck('unemployed')),
        populationDim = ndx.dimension(dc.pluck('population')),
        allDim = ndx.dimension(function(d) {
          return d;
        });


      // create groups (y-axis values)
      var all = ndx.groupAll();
        unemployedPerShape = shapeDim.group().reduceSum(function(d) {
          return Math.round(d.unemployed);
        }),
        unemployedPerDistrict = districtDim.group().reduceSum(function(d) {
          return Math.round(d.unemployed);
        }),
        populationPerDistrict = districtDim.group().reduceSum(function(d) {
          return d.population;
        }),
        countPerShape = shapeDim.group().reduceCount(),
        unemployedPercentPerYear = yearDim.group().reduce(
          function(p, v) {
            ++p.count
            p.sums += (v.unemployed / v.population);
            p.avgs = (p.count === 0) ? 0 : (p.sums / p.count) * 100;
            return p;
          },
          function(p, v) {
            --p.count
            p.sums -= (v.unemployed / v.population);
            p.avgs = (p.count === 0) ? 0 : (p.sums / p.count) * 100;
            return p;
          },
          function() {
            return {
              count: 0,
              sums: 0,
              avgs: 0
            };
          }
        ),
        unemployedPercentPerDistrict = districtDim.group().reduce(
          function(p, v) {
            ++p.count
            p.sums += (v.unemployed / v.population);
            p.avgs = (p.count === 0) ? 0 : (p.sums / p.count) * 100;
            return p;
          },
          function(p, v) {
            --p.count
            p.sums -= (v.unemployed / v.population);
            p.avgs = (p.count === 0) ? 0 : (p.sums / p.count) * 100;
            return p;
          },
          function() {
            return {
              count: 0,
              sums: 0,
              avgs: 0
            };
          }
        );

      // specify charts
      var yearChart = dc.pieChart('#chart-ring-year'),
        shapeChart = dc.pieChart('#chart-ring-shape'),
        districtChart = dc.rowChart("#chart-district"),
        districtPercentChart = dc.rowChart("#chart-district-percent"),
        // ibuCountChart  = dc.barChart('#chart-ibu-count'),
        dataCount = dc.dataCount('#foreigner-data-count'),
        dataTable = dc.dataTable('#data-table');

      yearChart
        .width(200)
        .height(200)
        .dimension(yearDim)
        .group(unemployedPercentPerYear)
        .valueAccessor(function(d) {
          return d.value.avgs;
        })
        .innerRadius(20);

      shapeChart
        .width(200)
        .height(200)
        .dimension(shapeDim)
        .group(unemployedPerShape)
        .innerRadius(20);

      districtChart
        // .width(650)
        .height(500)
        .x(d3.scale.linear().domain([6, 20]))
        .elasticX(true)
        .dimension(districtDim)
        .group(unemployedPerDistrict)
        .ordering(function(d) {
          return -d.value;
        });
      districtPercentChart
        // .width(650)
        .height(500)
        .x(d3.scale.linear().domain([6, 20]))
        .elasticX(true)
        .dimension(districtDim)
        .group(unemployedPercentPerDistrict)
        .valueAccessor(function(d) {
          return d.value.avgs;
        })
        .ordering(function(d) {
          return -d.value.avgs;
        });

      // ibuCountChart
      //     .width(300)
      //     .height(180)
      //     .dimension(ibuDim)
      //     .group(countPerIBU)
      //     .x(d3.scale.linear().domain([-2, d3.max(algiiData, function (d) { return d.beer.beer_ibu; }) + 2]))
      //     .elasticY(true)
      //     .centerBar(true)
      //     .barPadding(5)
      //     .xAxisLabel('International Bitterness Units')
      //     .yAxisLabel('Count')
      //     .xUnits(function (d) { return 5;})
      //     .margins({top: 10, right: 20, bottom: 50, left: 50});

      dataCount
        .dimension(ndx)
        .group(all);

      dataTable
        .dimension(allDim)
        .group(function(d) {
          return 'dummy row to remove later.';
        })
        .size(100)
        .columns([
          function(d) {
            return d.districtNumber;
          },
          function(d) {
            return d.district;
          },
          function(d) {
            return d.shape;
          },
          function(d) {
            return d.year;
          },
          function(d) {
            return d.population;
          },
          function(d) {
            return d.unemployed;
          }
        ])
        .sortBy(dc.pluck('rating_score'))
        .order(d3.descending)
        .on('renderlet', function(table) {
          // each time table is rendered remove nasty extra row dc.js insists on adding
          table.select('tr.dc-table-group').remove();
        });

      // register handlers
      d3.selectAll('a#all').on('click', function() {
        dc.filterAll();
        dc.renderAll();
      });

      d3.selectAll('a#year').on('click', function() {
        yearChart.filterAll();
        dc.redrawAll();
      });

      d3.selectAll('a#month').on('click', function() {
        shapeChart.filterAll();
        dc.redrawAll();
      });

      dc.renderAll();

    });


//////////////////////////////////////////////////////////////////////////////////////////////

        d3.json("data_foreigner_clean.json", function(dataForeigners) {
          d3.json("data_total.json", function(total) {
            d3.json("merged_births_foreigners_algii.json", function(dataTotal) {

              _.each(dataTotal, function(d) {
                d.year = +d.year;
                d.population = +d.population
                d.districtNumber = +d.districtNumber
                d.foreigners = +d.foreigners
                d.births = +d.births
                d.foreigners = +d.foreigners
              });




              var ndx = crossfilter(dataTotal);
              var yearDim = ndx.dimension(function(d) {
                  return d.year;
                }),
              shapeDim = ndx.dimension(dc.pluck('shape')),
              districtDim = ndx.dimension(dc.pluck('district')),
              unemployedDim = ndx.dimension(dc.pluck('unemployed')),
              foreignersDim = ndx.dimension(dc.pluck('foreigners')),
              birthsDim = ndx.dimension(dc.pluck('births')),
              populationDim = ndx.dimension(dc.pluck('population')),


              districtDimension = ndx.dimension(function(d) {return d.district;}),

              //yearDim = ndx.dimension(dc.pluck('year')),
              allDim = ndx.dimension(function(d) {
                return d;
              });


              var all = ndx.groupAll();
                districts = shapeDim.group().reduceSum(function(d){
                  return d.district;
                }),
                unemployedPerShape = shapeDim.group().reduceSum(function(d) {
                  return Math.round(parseFloat(d.unemployed));
                }),
                unemployedPerDistrict = districtDim.group().reduceSum(function(d) {
                  //console.log(d);
                  return Math.round(parseFloat(d.unemployed));
                }),
                populationPerDistrict = districtDim.group().reduceSum(function(d) {
                  return d.population;
                }),
                birthsPerDistrict = districtDim.group().reduceSum(function(d) {
                  return Math.round(parseFloat(d.births));
                }),
                foreignersPerDistrict = districtDim.group().reduceSum(function(d) {
                  return parseFloat(d.foreigners);
                }),
                countPerShape = shapeDim.group().reduceCount(),
                unemployedPercentPerYear = yearDim.group().reduce(
                  function(p, v) {
                    //console.log(p);
                    //console.log(v);
                    ++p.count
                    p.sums += (parseFloat(v.unemployed) / v.population);
                    p.avgs = (p.count === 0) ? 0 : (p.sums / p.count) * 100;
                    //console.log(p);
                    return p;
                  },
                  function(p, v) {
                    --p.count
                    p.sums -= (parseFloat(v.unemployed) / v.population);
                    p.avgs = (p.count === 0) ? 0 : (p.sums / p.count) * 100;
                    //console.log(parseFloat(p));
                    return p;
                  },
                  function() {
                    return {
                      count: 0,
                      sums: 0,
                      avgs: 0
                    };
                  }
                ),
                unemployedPercentPerDistrict = districtDim.group().reduce(
                  function(p, v) {
                    ++p.count
                    p.sums += (v.unemployed / v.population);
                    p.avgs = (p.count === 0) ? 0 : (p.sums / p.count) * 100;
                    return parseFloat(p);
                  },
                  function(p, v) {
                    --p.count
                    p.sums -= (v.unemployed / v.population);
                    p.avgs = (p.count === 0) ? 0 : (p.sums / p.count) * 100;
                    return parseFloat(p);
                  },
                  function() {
                    return {
                      count: 0,
                      sums: 0,
                      avgs: 0
                    };
                  }
                );

              var dataTable = dc.dataTable("#total-data-table");
              //var totalDistributionLineChart = dc.lineChart("#total-distribution");
              var yearChart = dc.pieChart("#distribution-chart-ring-year");
              var districtChart = dc.rowChart("#distribution-chart-district");
              var groupedBarChart = dc.compositeChart("#total-distribution");
              var map = dc.geoChoroplethChart('#munich-map');


              d3.json("munich.json", function (districtJson) {
            map.width(990)
                    .height(500)
                    .dimension(districtDim)
                    .group(populationPerDistrict)
                    .colors(d3.scale.quantize().range(["#E2F2FF", "#C4E4FF", "#9ED2FF", "#81C5FF", "#6BBAFF", "#51AEFF", "#36A2FF", "#1E96FF", "#0089FF", "#0061B5"]))
                    .colorDomain([0, 200])
                    .colorCalculator(function (d) { return d ? map.colors()(d) : '#ccc'; })
                    .overlayGeoJson(districtJson.features, "district", function (d) {
                      console.log(d);
                        return d.properties.name;
                    })
                .valueAccessor(function(kv) {
                    console.log(kv);
                    return kv.value;
                })
                    .title(function (d) {
                        return "State: " + d.key + "\nTotal Amount Raised: " + numberFormat(d.value ? d.value : 0) + "M";
                    });
                  });



             /*map.overlayGeoJson(districtJson.features, 'district', function(d) {
                console.log(d)
                  return d.properties.name;
              })*/

              yearChart
                .width(200)
                .height(200)
                .dimension(yearDim)
                .group(unemployedPercentPerYear)
                .valueAccessor(function(d) {
                  return d.value.avgs;
                })
                .innerRadius(20);




                districtChart
                  // .width(650)
                  .height(500)
                  .x(d3.scale.linear().domain([0, 20]))
                  .elasticX(true)
                  .dimension(districtDim)
                  .group(unemployedPerDistrict)
                  .ordering(function(d) {
                    return -d.value;
                  });


                  groupedBarChart
                  	//.width(700)
                  	.height(500)
                  	.transitionDuration(200)
                  	//.margins(margins)
                  	//.dimension(districtDimension)
                    .brushOn(false)
                    .group(unemployedPerDistrict)
                    .legend(dc.legend().x(40).y(0).itemHeight(16).gap(4))

                  	.elasticY(true)
                    //.elasticX(true)
                    .x(d3.scale.ordinal())
                    .xUnits(dc.units.ordinal)
                    //.xUnits(function(){return 5;})

                    .xAxisLabel('Stadtteil')
                    .yAxisLabel('Anzahl')

                    //.x(d3.scale.linear().domain([6, 70]))

                  	.renderHorizontalGridLines(true)
                  	.compose([
                      dc.barChart(groupedBarChart)
                        .group(unemployedPerDistrict, 'unemployed')
                        .dimension(districtDimension)
                        //.colors(['#ffaaff'])
                        .gap(70)
                        .centerBar(true),

                        /*.valueAccessor(function (d) {
                          return d.value;
                      }),*/

                      dc.barChart(groupedBarChart)
                        .group(foreignersPerDistrict, 'foreigners')
                        .dimension(districtDimension)
                        .gap(60)
                        //.xUnits(function(){return 15;})

                        //.colors(['#00aaff'])
                        .centerBar(true),


                      dc.barChart(groupedBarChart)
                        .group(birthsPerDistrict, 'births')
                        //.colors(['#aa00ff'])
                        .gap(50)
                        .centerBar(true)
                        /*.valueAccessor(function (d) {
                          return d.value;
                        })*/
                  			])
                        /*.on('renderlet', function(chart) {
                            chart.selectAll('rect').on("click", function(d) {
                                console.log("click!", d);
                            });

                        })*/
                        //.brushOn(false)
                        //.render();



                    //.on('renderlet', function(chart) {
                    //  chart.selectAll("g._1").attr("transform", "translate(" + 25 + ", 0)");
                      //console.log(chart);
                      // each time table is rendered remove nasty extra row dc.js insists on adding
                      //table.select('tr.dc-table-group').remove();

                    //});
                    //.chart.on("renderlet.<renderletKey>", renderletFunction)
                  	//.renderlet(function (chart) {
                  		//chart.selectAll("g._1").attr("transform", "translate(" + translate + ", 0)");
                	//});



              dataTable
                .dimension(allDim)
                .group(function(d) {
                  return 'dummy row to remove later.';
                })
                .size(100)
                .columns([
                  function(d) {
                    return d.districtNumber;
                  },
                  function(d) {
                    return d.district;
                  },
                  function(d) {
                    return d.shape;
                  },
                  function(d) {
                    return d.year;
                  },
                  function(d) {
                    return d.population;
                  },
                  function(d){
                    return d.foreigners;
                  },
                  function(d) {
                    return d.births;
                  },
                  function(d) {
                    return d.unemployed;
                  }
                ])
                .sortBy(dc.pluck('rating_score'))
                .order(d3.descending)
                .on('renderlet', function(table) {
                  // each time table is rendered remove nasty extra row dc.js insists on adding
                  table.select('tr.dc-table-group').remove();

                });

                d3.selectAll('a#year').on('click', function() {
                  yearChart.filterAll();
                  dc.redrawAll();
                });

                dc.renderAll();


              });
            });
          });
          /*d3.json('data_foreigner_clean.json', function(error, data) {
            var data = data;

            // normalize/parse data
            _.each(data, function(d) {
              d.year = +d.year;
              d.population = +d.population
              d.foreigners = +d.foreigners
              d.districtNumber = +d.districtNumber
            });

            var ndx = crossfilter(data);

            // create dimensions (x-axis values)
            var yearDim = ndx.dimension(function(d) {
                return d.year;
              }),
              //shapeDim = ndx.dimension(dc.pluck('shape')),
              districtDim = ndx.dimension(dc.pluck('district')),
              foreignersDim = ndx.dimension(dc.pluck('foreigners')),
              populationDim = ndx.dimension(dc.pluck('population')),
              allDim = ndx.dimension(function(d) {
                return d;
              });

              var all = ndx.groupAll();

                foreignerPerDistrict = districtDim.group().reduceSum(function(d) {
                  return Math.round(d.foreigners);
                }),
                populationPerDistrict = districtDim.group().reduceSum(function(d) {
                  return d.population;
                }),
                //countPerShape = shapeDim.group().reduceCount(),
                foreignersPercentPerYear = yearDim.group().reduce(
                  function(p, v) {
                    ++p.count
                    p.sums += (v.foreigners / v.population);
                    p.avgs = (p.count === 0) ? 0 : (p.sums / p.count) * 100;
                    return p;
                  },
                  function(p, v) {
                    --p.count
                    p.sums -= (v.foreigners / v.population);
                    p.avgs = (p.count === 0) ? 0 : (p.sums / p.count) * 100;
                    return p;
                  },
                  function() {
                    return {
                      count: 0,
                      sums: 0,
                      avgs: 0
                    };
                  }
                ),
                foreignersPercentPerDistrict = districtDim.group().reduce(
                  function(p, v) {
                    ++p.count
                    p.sums += (v.foreigners / v.population);
                    p.avgs = (p.count === 0) ? 0 : (p.sums / p.count) * 100;
                    return p;
                  },
                  function(p, v) {
                    --p.count
                    p.sums -= (v.foreigners / v.population);
                    p.avgs = (p.count === 0) ? 0 : (p.sums / p.count) * 100;
                    return p;
                  },
                  function() {
                    return {
                      count: 0,
                      sums: 0,
                      avgs: 0
                    };
                  }
                );

                var yearChart = dc.pieChart('#foreigner-chart-ring-year'),
                  districtChart = dc.rowChart("#foreigner-chart-district"),
                  districtPercentChart = dc.rowChart("#foreigner-chart-district-percent"),
                  // ibuCountChart  = dc.barChart('#chart-ibu-count'),
                  dataCount = dc.dataCount('#data-count'),
                  dataTable = dc.dataTable('#foreigner-data-table');

                yearChart
                  .width(200)
                  .height(200)
                  .dimension(yearDim)
                  .group(foreignersPercentPerYear)
                  .valueAccessor(function(d) {
                    return d.value.avgs;
                  })
                  .innerRadius(20);

                  districtChart
                    // .width(650)
                    .height(500)
                    .x(d3.scale.linear().domain([6, 20]))
                    .elasticX(true)
                    .dimension(districtDim)
                    .group(foreignerPerDistrict)
                    .ordering(function(d) {
                      return -d.value;
                    });

                    districtPercentChart
                      // .width(650)
                      .height(500)
                      .x(d3.scale.linear().domain([6, 20]))
                      .elasticX(true)
                      .dimension(districtDim)
                      .group(foreignersPercentPerDistrict)
                      .valueAccessor(function(d) {
                        return d.value.avgs;
                      })
                      .ordering(function(d) {
                        return -d.value.avgs;
                      });

                    dataCount
                        .dimension(ndx)
                        .group(all);

                    dataTable
                        .dimension(allDim)
                        .group(function(d) {
                          return 'dummy row to remove later.';
                        })
                        .size(100)
                        .columns([
                          function(d) {
                            return d.districtNumber;
                          },
                          function(d) {
                            return d.district;
                          },
                          function(d) {
                            return d.year;
                          },
                          function(d) {
                            return d.population;
                          },
                          function(d) {
                            return d.foreigners;
                          }
                        ])
                        .sortBy(dc.pluck('rating_score'))
                        .order(d3.descending)
                        .on('renderlet', function(table) {
                          // each time table is rendered remove nasty extra row dc.js insists on adding
                          table.select('tr.dc-table-group').remove();
                        });

        });*/



  </script>
</body>

</html>
